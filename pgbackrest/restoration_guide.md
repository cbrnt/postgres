
# Восстановление БД на example-db с помощью pgbackrest на произвольный момент времени (PITR)

## Очистка example-db кластера перед восстановлением в него дампа

Перед каждой командой указано, под каким пользователем она выполняется и на каком сервере кластера!

Прежде всего необходимо остановить `patroni` и удалить/переименовать директории с БД, а также удалить **НА ВСЕХ НОДАХ КЛАСТЕРА** информацию о кластере из DCS.

**ВНИМАНИЕ: данные могут быть важными**

```bash
[root@example-node01]# systemctl stop patroni
[root@example-node01]# mv /var/lib/pgsql/11/data /var/lib/pgsql/11/data_INTACT

[root@example-node02]# systemctl stop patroni 
[root@example-node02]# mv /var/lib/pgsql/11/data /var/lib/pgsql/11/data_INTACT

[root@example-node03]# systemctl stop patroni 
[root@example-node03]# mv /var/lib/pgsql/11/data /var/lib/pgsql/11/data_INTACT
```

Удаление кластера из DCS:

```bash
[root@example-node01]# python /opt/patroni/patronictl.py -c /etc/patroni/postgres.yml remove example-cluster
+ Cluster: example-cluster (7020136436799623667)+
| Member | Host | Role | State | TL | Lag in MB |
+--------+------+------+-------+----+-----------+
+--------+------+------+-------+----+-----------+
Please confirm the cluster name to remove: example-cluster
You are about to remove all information in DCS for example-cluster, please type: "Yes I am aware": Yes I am aware
```

Выполнить:

```bash
python /opt/patroni/patronictl.py -c /etc/patroni/postgres.yml list example-cluster
```

Результат: напротив имени кластера должно быть `uninitialized`, так мы понимаем, что в ETCD нет информации о кластере.

## Восстановление мастера (example-node01)

### Заливка данных из облака

На первой ноде запускаем процесс создания файловых структур кластера БД из архивной копии на YC S3.

```bash
[root@example-node01]# sudo su - postgres
[postgres@example-node01]$ pgbackrest --stanza=<STANZA_NAME> --pg1-path=/var/lib/pgsql/11/data --log-level-console=info --delta --type=time --target="<DATE_AND_TIME>" --target-action=promote restore
```

Проверяем созданный файл `recovery.conf`:

```bash
[postgres@example-node01]$ cat /var/lib/pgsql/11/data/recovery.conf
# Recovery settings generated by pgBackRest restore on <DATE_AND_TIME>
restore_command = 'pgbackrest --pg1-path=/var/lib/pgsql/11/data --stanza=<STANZA_NAME> archive-get %f "%p"'
recovery_target_time = '<DATE_AND_TIME>'
recovery_target_action = 'promote'
```

### Подготовка конфигурационных файлов

**ВАЖНО!!!**

Необходимо не допустить пересечения журналов WAL с восстанавливаемой БД и текущей боевой. Убедитесь, что параметр `archive_command` не указывает на хранилище S3 с данными боевой БД.

Настройки в `postgresql.conf`:

```bash
[postgres@example-node01]$ vim /var/lib/pgsql/11/data/postgresql.conf
archive_command = 'mkdir -p ../wal_archive && cp %p ../wal_archive/%f'
```

Настройки в `postgres.yml`:

```bash
[root@example-node01]# vim /etc/patroni/postgres.yml
parameters:
  archive_command: mkdir -p ../wal_archive && cp %p ../wal_archive/%f
```

Запуск БД для применения WAL-журналов:

```bash
[root@example-node01]# sudo su - postgres
[postgres@example-node01]$ /usr/pgsql-11/bin/postmaster -D /var/lib/pgsql/11/data --config-file=/var/lib/pgsql/11/data/postgresql.conf
```

Отслеживаем процесс:

```bash
[postgres@example-node01]$ tail -100f /var/log/postgresql/postgresql.log
```

Останавливаем сервер PostgreSQL с помощью комбинации Ctrl+C.

### Запуск patroni

Подготовка:

Удалите следующие файлы:

```bash
[postgres@example-node01]$ rm -f /var/lib/pgsql/11/data/patroni.dynamic.json && rm -f /var/lib/pgsql/11/data/postgresql.conf
```

Запуск лидера:

```bash
[root@example-node01]# systemctl start patroni
[root@example-node01]# systemctl start keepalived && systemctl start haproxy && systemctl start etcd
```

На этот момент восстановление МАСТЕРА закончено.

## Восстановление репликации

Измените пароли для `postgres`, `superuser`, `repuser`, чтобы реплики могли подтянуться после запуска patroni на них.

```bash
[root@example-node01]# psql -U postgres
ALTER USER superuser WITH PASSWORD '<SU_PASSWORD_FROM_PATRONI.YML>'; 
ALTER USER postgres WITH PASSWORD '<PG_PASSWORD_FROM_PATRONI.YML>'; 
ALTER USER repuser WITH PASSWORD '<REP_PASSWORD_FROM_PATRONI.YML>';
\q!
```

Создание каталога для БД на всех остальных нодах кластера:

```bash
[root@example-node02]# mkdir /var/lib/pgsql/11/data && chown postgres:postgres /var/lib/pgsql/11/data && chmod 740 /var/lib/pgsql/11/data && chmod g-r /var/lib/pgsql/11/data
[root@example-node02]# systemctl start patroni
[root@example-node03]# mkdir /var/lib/pgsql/11/data && chown postgres:postgres /var/lib/pgsql/11/data && chmod 740 /var/lib/pgsql/11/data && chmod g-r /var/lib/pgsql/11/data
[root@example-node03]# systemctl start patroni
```

Проверяем процесс создания реплик:

```bash
[root@example-node01 ~]# python /opt/patroni/patronictl.py -c /etc/patroni/postgres.yml list example-cluster
```

## Проверка работы кластера

Запустите `psql` на мастере и выполните команду `checkpoint`:

```bash
[root@example-node01]# psql -U postgres
postgres=# checkpoint;
CHECKPOINT
postgres=# \c example-db
example-db=# checkpoint;
CHECKPOINT
```
